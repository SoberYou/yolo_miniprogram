<view class="container">
  <!-- Custom Header -->
  <view class="custom-header">
    <view class="header-content">
      <view class="back-btn" bindtap="goBack">
        <view class="back-arrow"></view>
      </view>
      <text class="page-title">里程碑</text>
    </view>
  </view>

  <view class="main-content">
    <view class="section-header">
      <view class="add-btn" bindtap="openAddModal">+</view>
      <view class="tab-switcher">
        <view class="tab-item {{currentTab === 'date' ? 'active' : ''}}" bindtap="switchTab" data-tab="date">日期</view>
        <view class="tab-item {{currentTab === 'bottle' ? 'active' : ''}}" bindtap="switchTab" data-tab="bottle">玻璃瓶</view>
      </view>
    </view>
    
    <scroll-view wx:if="{{currentTab === 'date'}}" scroll-y class="timeline-container">
      <view class="timeline">
        <block wx:for="{{milestones}}" wx:key="id">
        <view class="timeline-item">
          <view class="timeline-date">
            <text class="day">{{item.milestoneDate}}</text>
          </view>
          
          <view class="swipe-container">
            <view class="swipe-actions">
              <view class="delete-btn" catchtap="deleteMilestone" data-id="{{item.id}}">删除</view>
            </view>
            
            <view 
              class="timeline-content" 
              bindtap="openEditModal" 
              data-id="{{item.id}}"
              bindtouchstart="handleTouchStart"
              bindtouchmove="handleTouchMove"
              bindtouchend="handleTouchEnd"
              data-index="{{index}}"
              style="transform: translateX({{item.x}}rpx); transition: transform 0.3s;"
            >
              <view class="marker"></view>
              <view class="card">
                <text class="title">{{item.milestoneTitle}}</text>
              </view>
            </view>
          </view>

        </view>
      </block>
      <view wx:if="{{milestones.length === 0}}" class="empty-state">
        <text>暂无里程碑，点击上方按钮添加</text>
      </view>
    </view>
    </scroll-view>

    <!-- Wishing Bottle View -->
    <view wx:if="{{currentTab === 'bottle'}}" class="bottle-container">
       <canvas type="2d" id="bottleCanvas" class="bottle-canvas" bindtouchstart="handleCanvasTouch"></canvas>
    </view>
  </view>

  <!-- Add/Edit Modal -->
  <page-container show="{{showModal}}" position="center" round overlay custom-style="background-color: transparent;">
    <view class="modal-overlay">
      <view class="modal-content">
        <view class="modal-header">{{isEdit ? '编辑里程碑' : '新增里程碑'}}</view>
        
        <view class="form-item">
          <picker mode="date" value="{{formData.milestoneDate}}" bindchange="handleDateChange">
            <view class="picker-view">
              日期: {{formData.milestoneDate}}
            </view>
          </picker>
        </view>

        <view class="form-item">
          <input class="modal-input" placeholder="里程碑标题" bindinput="handleInput" data-field="milestoneTitle" value="{{formData.milestoneTitle}}" />
        </view>
        
        <view class="form-item">
          <textarea class="modal-textarea" placeholder="描述 (可选)" bindinput="handleInput" data-field="milestoneDesc" value="{{formData.milestoneDesc}}" />
        </view>

        <view class="form-item">
          <textarea class="modal-textarea" placeholder="感悟 (可选)" bindinput="handleInput" data-field="ownFeel" value="{{formData.ownFeel}}" />
        </view>
        
        <view class="modal-actions">
          <button class="modal-btn cancel" bindtap="closeModal">取消</button>
          <button class="modal-btn confirm" bindtap="saveMilestone">保存</button>
        </view>
      </view>
    </view>
  </page-container>
</view>