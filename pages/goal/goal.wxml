<!-- pages/goal/goal.wxml -->
<view class="container" bindtap="hideLegendTip">
  <!-- Custom Header -->
  <view class="custom-header" style="height: {{navBarHeight}}px; padding-top: {{statusBarHeight}}px;">
    <view class="header-content" style="height: {{menuButtonHeight}}px; line-height: {{menuButtonHeight}}px;">
      <view class="back-btn" bindtap="goBack">
        <view class="back-arrow"></view>
      </view>
      <text class="page-title">{{goal.name}}</text>
      <view class="edit-btn" bindtap="openEditModal" style="margin-left: auto; margin-right: 16px;">
        <text style="font-size: 14px; color: #666;">编辑</text>
      </view>
    </view>
  </view>

  <!-- Edit Modal -->
  <page-container show="{{showEditModal}}" position="center" round overlay custom-style="background-color: transparent;">
    <view class="modal-overlay">
      <view class="modal-content">
        <view class="modal-header">编辑目标</view>
        
        <view class="form-item">
          <input class="modal-input" placeholder="目标名称 (Title)" bindinput="handleTitleInput" value="{{editGoal.title}}" />
        </view>
        
        <view class="form-item">
          <textarea class="modal-textarea" placeholder="描述 (Description)" bindinput="handleDescriptionInput" value="{{editGoal.description}}" />
        </view>
        
        <view class="form-item">
          <input class="modal-input" type="number" placeholder="预期投入小时数" bindinput="handleHoursInput" value="{{editGoal.expected_total_hours}}" />
        </view>
        
        <view class="form-item category-selection">
          <text class="category-label">北极星</text>
          <view class="category-chips">
            <block wx:for="{{categories}}" wx:key="*this">
              <view 
                class="category-chip {{editGoal.north_star === item ? 'selected' : ''}}" 
                bindtap="selectCategory" 
                data-value="{{item}}"
              >
                {{item}}
              </view>
            </block>
          </view>
        </view>
        
        <view class="modal-actions">
          <button class="modal-btn cancel" bindtap="closeEditModal">取消</button>
          <button class="modal-btn confirm" bindtap="submitEdit">保存</button>
        </view>
      </view>
    </view>
  </page-container>

  <!-- Main Content -->
  <scroll-view scroll-y class="main-content" style="padding-top: {{statusBarHeight}}px;">
    
    <!-- Title & Description -->
    <view class="section-header">
      <view class="goal-title">{{goal.name}}</view>
      <view class="goal-desc-group">
        <text class="goal-desc">{{goal.description || '暂无描述'}}</text>
        <view class="goal-progress-container">
          <text class="goal-desc sub">{{goal.northStar}} · </text>
          <view class="progress-bar-wrapper" catchtap="showProgressTooltip" data-total-hours="{{goal.totalHours}}">
             <view class="progress-bar-bg">
               <view class="progress-bar-fill" style="width: {{goal.progressPercent}}%;"></view>
             </view>
             <!-- Tooltip -->
             <view class="progress-tooltip" wx:if="{{progressTooltip.show}}">
               {{progressTooltip.text}}
             </view>
          </view>
          <text class="goal-desc sub">  {{goal.expectedTotalHours}} h</text>
        </view>
      </view>
    </view>

    <!-- Time Investment Stats -->
    <view class="section-stats">
      <view class="stat-card">
        <text class="stat-label">近 7 天</text>
        <text class="stat-value">{{goal.stats.last7Days}}</text>
      </view>
      <view class="stat-card">
        <text class="stat-label">近 30 天</text>
        <text class="stat-value">{{goal.stats.last30Days}}</text>
      </view>
    </view>

    <!-- History List (Heatmap) -->
    <view class="section-history">
      <view class="history-header">
        <view class="history-label">专注分布</view>
        <view class="milestone-btn" bindtap="goToMilestone">
           <text class="milestone-text">里程碑</text>
           <view class="milestone-arrow"></view>
        </view>
      </view>
      
      <view class="heatmap-container">
        <!-- Left Labels (Mon-Sun) -->
        <view class="weekday-labels">
          <text class="weekday-label">1</text>
          <text class="weekday-label">2</text>
          <text class="weekday-label">3</text>
          <text class="weekday-label">4</text>
          <text class="weekday-label">5</text>
          <text class="weekday-label">6</text>
          <text class="weekday-label">7</text>
        </view>

        <!-- Scrollable Heatmap -->
        <scroll-view scroll-x class="heatmap-scroll" scroll-left="{{scrollLeft}}">
          <view class="heatmap-content">
            <!-- Month Labels -->
            <view class="months-row">
              <block wx:for="{{goal.heatmap}}" wx:key="index">
                <view class="month-col">
                  <text class="month-text" wx:if="{{item.month}}">{{item.month}}</text>
                </view>
              </block>
            </view>

            <!-- Grid -->
            <view class="weeks-row">
              <block wx:for="{{goal.heatmap}}" wx:key="index" wx:for-item="week">
                <view class="week-col">
                  <block wx:for="{{week.days}}" wx:key="date" wx:for-item="day">
                    <view class="day-cell level-{{day.level}}"></view>
                  </block>
                </view>
              </block>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- Legend -->
      <view class="heatmap-legend">
        <text class="legend-text">Less</text>
        <view class="legend-items">
          <view class="legend-tooltip" wx:if="{{legendTip.show}}" style="left: {{legendTip.left}}px;">
            {{legendTip.text}}
          </view>
          <view class="day-cell level-0" catchtap="showLegendTip" data-level="0"></view>
          <view class="day-cell level-1" catchtap="showLegendTip" data-level="1"></view>
          <view class="day-cell level-2" catchtap="showLegendTip" data-level="2"></view>
          <view class="day-cell level-3" catchtap="showLegendTip" data-level="3"></view>
          <view class="day-cell level-4" catchtap="showLegendTip" data-level="4"></view>
        </view>
        <text class="legend-text">More</text>
      </view>
    </view>

    <!-- Actions -->
    <view class="section-actions">
      <button class="btn-primary" bindtap="startFocus">{{runningSession ? '进行中' : '开始专注'}}</button>
      <button class="btn-secondary" bindtap="editGoal">编辑目标</button>
    </view>

    <!-- Footer Padding -->
    <view style="height: 40px;"></view>

  </scroll-view>
</view>
